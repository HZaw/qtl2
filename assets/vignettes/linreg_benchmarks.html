<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>Benchmarks of linear regression routines</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link href="data:text/css,body%20%7B%0A%20%20background%2Dcolor%3A%20%23fff%3B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20max%2Dwidth%3A%20700px%3B%0A%20%20overflow%3A%20visible%3B%0A%20%20padding%2Dleft%3A%202em%3B%0A%20%20padding%2Dright%3A%202em%3B%0A%20%20font%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20font%2Dsize%3A%2014px%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%7D%0A%0A%23header%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%23TOC%20%7B%0A%20%20clear%3A%20both%3B%0A%20%20margin%3A%200%200%2010px%2010px%3B%0A%20%20padding%3A%204px%3B%0A%20%20width%3A%20400px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20border%2Dradius%3A%205px%3B%0A%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20font%2Dsize%3A%2013px%3B%0A%20%20line%2Dheight%3A%201%2E3%3B%0A%7D%0A%20%20%23TOC%20%2Etoctitle%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%20%20font%2Dsize%3A%2015px%3B%0A%20%20%20%20margin%2Dleft%3A%205px%3B%0A%20%20%7D%0A%0A%20%20%23TOC%20ul%20%7B%0A%20%20%20%20padding%2Dleft%3A%2040px%3B%0A%20%20%20%20margin%2Dleft%3A%20%2D1%2E5em%3B%0A%20%20%20%20margin%2Dtop%3A%205px%3B%0A%20%20%20%20margin%2Dbottom%3A%205px%3B%0A%20%20%7D%0A%20%20%23TOC%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dleft%3A%20%2D2em%3B%0A%20%20%7D%0A%20%20%23TOC%20li%20%7B%0A%20%20%20%20line%2Dheight%3A%2016px%3B%0A%20%20%7D%0A%0Atable%20%7B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dcolor%3A%20%23DDDDDD%3B%0A%20%20border%2Dstyle%3A%20outset%3B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0A%20%20border%2Dwidth%3A%202px%3B%0A%20%20padding%3A%205px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%20%20line%2Dheight%3A%2018px%3B%0A%20%20padding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0A%20%20border%2Dleft%2Dstyle%3A%20none%3B%0A%20%20border%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%2E5em%200%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20padding%3A%200%2E25em%200%2E75em%3B%0A%7D%0A%0Ahr%20%7B%0A%20%20border%2Dstyle%3A%20solid%3B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23777%3B%0A%20%20margin%3A%2028px%200%3B%0A%7D%0A%0Adl%20%7B%0A%20%20margin%2Dleft%3A%200%3B%0A%7D%0A%20%20dl%20dd%20%7B%0A%20%20%20%20margin%2Dbottom%3A%2013px%3B%0A%20%20%20%20margin%2Dleft%3A%2013px%3B%0A%20%20%7D%0A%20%20dl%20dt%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%7D%0A%0Aul%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%7D%0A%20%20ul%20li%20%7B%0A%20%20%20%20list%2Dstyle%3A%20circle%20outside%3B%0A%20%20%7D%0A%20%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dbottom%3A%200%3B%0A%20%20%7D%0A%0Apre%2C%20code%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20color%3A%20%23333%3B%0A%7D%0Apre%20%7B%0A%20%20white%2Dspace%3A%20pre%2Dwrap%3B%20%20%20%20%2F%2A%20Wrap%20long%20lines%20%2A%2F%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20margin%3A%205px%200px%2010px%200px%3B%0A%20%20padding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0A%20%20font%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0A%20%20padding%3A%202px%200px%3B%0A%7D%0A%0Adiv%2Efigure%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0A%20%20background%2Dcolor%3A%20%23FFFFFF%3B%0A%20%20padding%3A%202px%3B%0A%20%20border%3A%201px%20solid%20%23DDDDDD%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20margin%3A%200%205px%3B%0A%7D%0A%0Ah1%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%20%20font%2Dsize%3A%2035px%3B%0A%20%20line%2Dheight%3A%2040px%3B%0A%7D%0A%0Ah2%20%7B%0A%20%20border%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20padding%2Dbottom%3A%202px%3B%0A%20%20font%2Dsize%3A%20145%25%3B%0A%7D%0A%0Ah3%20%7B%0A%20%20border%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20font%2Dsize%3A%20120%25%3B%0A%7D%0A%0Ah4%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0A%20%20margin%2Dleft%3A%208px%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Ah5%2C%20h6%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23ccc%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Aa%20%7B%0A%20%20color%3A%20%230033dd%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%236666ff%3B%20%7D%0A%20%20a%3Avisited%20%7B%0A%20%20%20%20color%3A%20%23800080%3B%20%7D%0A%20%20a%3Avisited%3Ahover%20%7B%0A%20%20%20%20color%3A%20%23BB00BB%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%0A%2F%2A%20Class%20described%20in%20https%3A%2F%2Fbenjeffrey%2Ecom%2Fposts%2Fpandoc%2Dsyntax%2Dhighlighting%2Dcss%0A%20%20%20Colours%20from%20https%3A%2F%2Fgist%2Egithub%2Ecom%2Frobsimmons%2F1172277%20%2A%2F%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Keyword%20%2A%2F%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%2F%2A%20DataType%20%2A%2F%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%2F%2A%20DecVal%20%28decimal%20values%29%20%2A%2F%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20BaseN%20%2A%2F%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Float%20%2A%2F%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Char%20%2A%2F%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20String%20%2A%2F%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%2F%2A%20Comment%20%2A%2F%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%2F%2A%20OtherToken%20%2A%2F%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20AlertToken%20%2A%2F%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Function%20calls%20%2A%2F%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%2F%2A%20ErrorTok%20%2A%2F%0A%0A" rel="stylesheet" type="text/css" />

</head>

<body>



<div id="header">
<h1 class="title">Benchmarks of linear regression routines</h1>
</div>


<p><a href="https://github.com/kbroman/qtl2">R/qtl2</a> includes code with several options for linear regression. We’re mostly focusing on using the <a href="http://eigen.tuxfamily.org">Eigen library</a> via <a href="https://github.com/RcppCore/RcppEigen">RcppEigen</a>, particularly linear regression via QR decomposition with column pivoting. We want speed, but we often have to deal with rank-deficient matrices.</p>
<p>In addition to routines that return coefficient estimates and estimated standard errors (SEs), we also have routines that return just the residual sum of squares (RSS), as for the calculation of LOD scores, that’s all that matters. We might perform a lot of regressions, getting just the RSS as a measure of quality-of-fit, and then go back to the interesting cases to look at the full set of coefficients and SEs.</p>
<p>Here, we present a few benchmarks comparing a couple of different routines from the <a href="http://eigen.tuxfamily.org">Eigen library</a> (QR decomposition with column pivoting and Cholesky decomposition; the latter doesn’t handle the rank-deficient case). We compare these to the <a href="http://www.netlib.org/lapack/">LAPACK</a> routines used in <a href="http://rqtl.org">R/qtl</a>: <a href="http://www.netlib.org/lapack/explore-html/d8/dde/dgels_8f.html"><code>dgels</code></a> and <a href="http://www.netlib.org/lapack/explore-html/d6/d4b/dgelsy_8f.html"><code>dgelsy</code></a>. We also consider R’s <code>lm.fit</code>, which is the workhorse behind <code>lm</code>.</p>
<p>These linear regression functions are not exported, so we need to use <code>qtl2:::</code>.</p>
<div id="simple-case" class="section level2">
<h2>Simple case</h2>
<p>First let’s look at a simple case, of a single covariate.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">27343534</span>)
n &lt;-<span class="st"> </span><span class="dv">1000</span>
x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">50</span>, <span class="dv">10</span>)
X &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dv">1</span>, x)
y &lt;-<span class="st"> </span><span class="dv">30</span> +<span class="st"> </span><span class="fl">0.5</span>*x +<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">0</span>, <span class="fl">2.5</span>)
Y &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(y)</code></pre>
<p>We use the <a href="http://cran.r-project.org/web/packages/microbenchmark/">microbenchmark package</a> and run each of the routines 1000 times.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(qtl2)
<span class="kw">library</span>(microbenchmark)
<span class="kw">microbenchmark</span>(<span class="dt">lmfit =</span>        <span class="kw">lm.fit</span>(X, y),
               <span class="dt">dgels=</span>         qtl2:::<span class="kw">calc_rss_lapack</span>(X, Y),
               <span class="dt">dgelsy=</span>        qtl2:::<span class="kw">calc_rss_lapack</span>(X, Y, <span class="dt">skip_dgels=</span><span class="ot">TRUE</span>),
               <span class="dt">eigen_qr_rss=</span>  qtl2:::<span class="kw">calc_rss_eigenqr</span>(X, y),
               <span class="dt">eigen_qr=</span>      qtl2:::<span class="kw">fit_linreg_eigenqr</span>(X, y),
               <span class="dt">eigen_chol_rss=</span>qtl2:::<span class="kw">calc_rss_eigenchol</span>(X, y),
               <span class="dt">eigen_chol=</span>    qtl2:::<span class="kw">fit_linreg_eigenchol</span>(X, y),
               <span class="dt">times=</span><span class="dv">1000</span>)</code></pre>
<pre><code>## Unit: microseconds
##            expr    min      lq      mean median      uq      max neval  cld
##           lmfit 90.399 96.2115 113.99935 97.590 99.3680 1233.426  1000    d
##           dgels 32.299 34.3305  35.99041 35.284 36.2300   64.004  1000 ab  
##          dgelsy 41.489 43.4830  45.55658 44.411 45.3945  236.519  1000   c 
##    eigen_qr_rss 27.174 28.6345  30.46110 29.366 30.4540  102.910  1000 a   
##        eigen_qr 31.318 33.0575  40.05313 33.900 35.2005 1001.050  1000  bc 
##  eigen_chol_rss 24.403 26.0185  28.99692 26.814 28.0590  943.091  1000 a   
##      eigen_chol 28.575 30.4260  34.27309 31.296 32.7270 1370.689  1000 ab</code></pre>
<p>It’s easy to beat <code>lm.fit</code>, but it’s great to see considerable gains with Eigen over LAPACK. The use of the Cholesky decomposition is somewhat faster than QR decomposition, but it can’t be used in the rank-deficient case.</p>
</div>
<div id="rank-deficient-case" class="section level2">
<h2>Rank-deficient case</h2>
<p>Let’s now consider a rank-deficient case. We use an example from <a href="http://www.jstatsoft.org/v52/i05/">Bates and Eddelbuettel (2013)</a> (the <a href="https://github.com/RcppCore/RcppEigen">RcppEigen</a> paper).</p>
<pre class="sourceCode r"><code class="sourceCode r">dd &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">f1 =</span> <span class="kw">gl</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dt">labels =</span> LETTERS[<span class="dv">1</span>:<span class="dv">4</span>]),
                 <span class="dt">f2 =</span> <span class="kw">gl</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dt">labels =</span> letters[<span class="dv">1</span>:<span class="dv">3</span>]))[-(<span class="dv">7</span>:<span class="dv">8</span>), ]
mm &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(~<span class="st"> </span>f1*f2, dd)
y &lt;-<span class="st"> </span>mm %*%<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">ncol</span>(mm)) +<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(mm), <span class="dt">sd =</span> <span class="fl">0.1</span>)
Y &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(y)</code></pre>
<p>And here are the benchmark results.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">microbenchmark</span>(<span class="dt">lmfit=</span>       <span class="kw">lm.fit</span>(mm, y),
               <span class="dt">dgels=</span>       qtl2:::<span class="kw">calc_rss_lapack</span>(mm, Y),
               <span class="dt">dgelsy=</span>      qtl2:::<span class="kw">calc_rss_lapack</span>(mm, Y, <span class="dt">skip_dgels=</span><span class="ot">TRUE</span>),
               <span class="dt">eigen_qr_rss=</span>qtl2:::<span class="kw">calc_rss_eigenqr</span>(mm, y),
               <span class="dt">eigen_qr=</span>    qtl2:::<span class="kw">fit_linreg_eigenqr</span>(mm, y),
               <span class="dt">times=</span><span class="dv">1000</span>)</code></pre>
<pre><code>## Unit: microseconds
##          expr    min      lq     mean  median      uq      max neval cld
##         lmfit 64.975 71.6760 78.94010 73.4310 77.3565 1654.862  1000   c
##         dgels 30.252 32.3895 38.09745 33.7885 35.5065 1570.090  1000  b 
##        dgelsy 24.420 26.3170 28.66399 27.7355 29.4170  127.572  1000 a  
##  eigen_qr_rss 19.978 22.5710 25.09874 24.2310 26.2840   90.411  1000 a  
##      eigen_qr 23.919 26.3075 29.17958 28.2150 30.8775   58.901  1000 a</code></pre>
<p>We skip the methods based on Cholesky decomposition, but we again see performance gains with Eigen over LAPACK.</p>
<p><code>dgels</code> is slower than <code>dgelsy</code> here, because with that routine, I’m calling <code>dgels</code> to check the matrix rank and then switch to <code>dgelsy</code> if the matrix is rank-deficient.</p>
</div>
<div id="bigger-matrix" class="section level2">
<h2>Bigger matrix</h2>
<p>Let’s consider a bigger matrix, with 2,500 rows and 300 columns. I don’t want it to be too big, or compiling this vignette will take too long. Try this yourself with bigger matrices, if you want.</p>
<pre class="sourceCode r"><code class="sourceCode r">n &lt;-<span class="st"> </span><span class="dv">2500</span>
p &lt;-<span class="st"> </span><span class="dv">300</span>
X &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(n*p), <span class="dt">nrow=</span>n)
y &lt;-<span class="st"> </span>X %*%<span class="st"> </span><span class="kw">runif</span>(p) +<span class="st"> </span><span class="kw">rnorm</span>(n)
Y &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(y)</code></pre>
<p>We use the full set again, as we can assume this to be a full-rank case. But we’ll just do 10 replicates.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">microbenchmark</span>(<span class="dt">lmfit =</span>        <span class="kw">lm.fit</span>(X, y),
               <span class="dt">dgels=</span>         qtl2:::<span class="kw">calc_rss_lapack</span>(X, Y),
               <span class="dt">dgelsy=</span>        qtl2:::<span class="kw">calc_rss_lapack</span>(X, Y, <span class="dt">skip_dgels=</span><span class="ot">TRUE</span>),
               <span class="dt">eigen_qr_rss=</span>  qtl2:::<span class="kw">calc_rss_eigenqr</span>(X, y),
               <span class="dt">eigen_qr=</span>      qtl2:::<span class="kw">fit_linreg_eigenqr</span>(X, y),
               <span class="dt">eigen_chol_rss=</span>qtl2:::<span class="kw">calc_rss_eigenchol</span>(X, y),
               <span class="dt">eigen_chol=</span>    qtl2:::<span class="kw">fit_linreg_eigenchol</span>(X, y),
               <span class="dt">times=</span><span class="dv">10</span>)</code></pre>
<pre><code>## Unit: milliseconds
##            expr       min        lq      mean    median        uq       max neval cld
##           lmfit 155.56928 157.41375 182.48762 166.67015 181.96706 299.85849    10   c
##           dgels 173.15126 176.08811 189.22620 181.78788 189.11817 262.73471    10   c
##          dgelsy 178.91874 181.81931 191.08771 188.30218 191.61163 228.37509    10   c
##    eigen_qr_rss 106.67868 111.48155 144.73867 139.78596 170.55501 196.60863    10  b 
##        eigen_qr 124.59601 125.24169 140.66867 131.57749 152.41601 203.28042    10  b 
##  eigen_chol_rss  22.81412  22.94795  26.38286  24.73453  28.44321  35.38216    10 a  
##      eigen_chol  25.76875  26.01814  28.22725  26.72947  28.37233  37.40611    10 a</code></pre>
</div>
<div id="multiple-phenotypes" class="section level2">
<h2>Multiple phenotypes</h2>
<p>We’ll go back to the case with a single covariate, but we’ll consider 500 phenotypes. We have a few routines to handle this, focusing solely on calculating the residual sum of squares for each phenotype.</p>
<pre class="sourceCode r"><code class="sourceCode r">n &lt;-<span class="st"> </span><span class="dv">1000</span>
x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">50</span>, <span class="dv">10</span>)
X &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dv">1</span>, x)
y &lt;-<span class="st"> </span><span class="dv">30</span> +<span class="st"> </span><span class="fl">0.5</span>*x +<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">0</span>, <span class="fl">2.5</span>)
Y &lt;-<span class="st"> </span>qtl2:::<span class="kw">permute_nvector</span>(<span class="dv">500</span>, y)</code></pre>
<p>Now we’ll get the benchmarks.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">microbenchmark</span>(<span class="dt">lmfit =</span>    <span class="kw">colSums</span>(<span class="kw">lm.fit</span>(X, Y)$resid^<span class="dv">2</span>),
               <span class="dt">dgels=</span>     qtl2:::<span class="kw">calc_rss_lapack</span>(X, Y),
               <span class="dt">dgelsy=</span>    qtl2:::<span class="kw">calc_rss_lapack</span>(X, Y, <span class="dt">skip_dgels=</span><span class="ot">TRUE</span>),
               <span class="dt">eigen_qr=</span>  qtl2:::<span class="kw">calc_mvrss_eigenqr</span>(X, Y),
               <span class="dt">eigen_chol=</span>qtl2:::<span class="kw">calc_mvrss_eigenchol</span>(X, Y),
               <span class="dt">times=</span><span class="dv">50</span>)</code></pre>
<pre><code>## Unit: milliseconds
##        expr       min        lq      mean    median        uq      max neval cld
##       lmfit 10.508951 48.807706 60.358575 52.677402 78.692688 98.28051    50   b
##       dgels  3.416899  4.220708  5.299433  4.517682  5.845089 11.87299    50  a 
##      dgelsy  3.921595  4.298323  5.569192  4.627801  6.747561 10.40646    50  a 
##    eigen_qr  4.531927  5.863435  7.171044  6.247683  7.409643 17.30658    50  a 
##  eigen_chol  4.435780  5.551048  7.229879  5.994992  7.870554 14.05860    50  a</code></pre>
</div>
<div id="multiple-phenotypes-rank-deficient-matrix" class="section level2">
<h2>Multiple phenotypes, rank-deficient matrix</h2>
<p>Let’s do the same thing with a rank-deficient matrix.</p>
<pre class="sourceCode r"><code class="sourceCode r">dd &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">f1 =</span> <span class="kw">gl</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dt">labels =</span> LETTERS[<span class="dv">1</span>:<span class="dv">4</span>]),
                 <span class="dt">f2 =</span> <span class="kw">gl</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dt">labels =</span> letters[<span class="dv">1</span>:<span class="dv">3</span>]))[-(<span class="dv">7</span>:<span class="dv">8</span>), ]
mm &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(~<span class="st"> </span>f1*f2, dd)
y &lt;-<span class="st"> </span>mm %*%<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">ncol</span>(mm)) +<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(mm), <span class="dt">sd =</span> <span class="fl">0.1</span>)
Y &lt;-<span class="st"> </span>qtl2:::<span class="kw">permute_nvector</span>(<span class="dv">500</span>, y)</code></pre>
<p>And here are the benchmarks.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">microbenchmark</span>(<span class="dt">lmfit =</span>    <span class="kw">colSums</span>(<span class="kw">lm.fit</span>(mm, Y)$resid^<span class="dv">2</span>),
               <span class="dt">dgels=</span>     qtl2:::<span class="kw">calc_rss_lapack</span>(mm, Y),
               <span class="dt">dgelsy=</span>    qtl2:::<span class="kw">calc_rss_lapack</span>(mm, Y, <span class="dt">skip_dgels=</span><span class="ot">TRUE</span>),
               <span class="dt">eigen_qr=</span>  qtl2:::<span class="kw">calc_mvrss_eigenqr</span>(mm, Y),
               <span class="dt">times=</span><span class="dv">100</span>)</code></pre>
<pre><code>## Unit: microseconds
##      expr     min       lq      mean   median        uq      max neval  cld
##     lmfit 775.462 891.5415 1056.7933 954.5615 1093.4985 4969.231   100    d
##     dgels 720.558 767.7020  834.6892 792.3300  873.2380 1249.743   100   c 
##    dgelsy 447.490 456.1560  515.9161 489.6580  533.4515  800.634   100 a   
##  eigen_qr 540.862 600.5855  659.1235 644.5555  694.7915  979.031   100  b</code></pre>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<p>The following shows the R and package versions I was using.</p>
<pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">session_info</span>()</code></pre>
<pre><code>## Session info ---------------------------------------------------------------------------------------</code></pre>
<pre><code>##  setting  value                       
##  version  R version 3.2.0 (2015-04-16)
##  system   x86_64, darwin13.4.0        
##  ui       X11                         
##  language en_US.UTF-8                 
##  collate  en_US.UTF-8                 
##  tz       America/Chicago</code></pre>
<pre><code>## Packages -------------------------------------------------------------------------------------------</code></pre>
<pre><code>##  package        * version    date       source                          
##  assertthat       0.1        2013-12-06 CRAN (R 3.2.0)                  
##  bitops           1.0-6      2013-08-17 CRAN (R 3.2.0)                  
##  broman         * 0.55-3     2015-04-27 local                           
##  codetools        0.2-11     2015-03-10 CRAN (R 3.2.0)                  
##  colorspace       1.2-6      2015-03-11 CRAN (R 3.2.0)                  
##  devtools         1.8.0.9000 2015-05-12 Github (hadley/devtools@dc61a9e)
##  digest           0.6.8      2014-12-31 CRAN (R 3.2.0)                  
##  evaluate         0.7        2015-04-21 CRAN (R 3.2.0)                  
##  formatR          1.2        2015-04-21 CRAN (R 3.2.0)                  
##  ggplot2          1.0.1      2015-03-17 CRAN (R 3.2.0)                  
##  git2r            0.10.1     2015-05-07 CRAN (R 3.2.0)                  
##  gtable           0.1.2      2012-12-05 CRAN (R 3.2.0)                  
##  htmltools        0.2.6      2014-09-08 CRAN (R 3.2.0)                  
##  jsonlite         0.9.16     2015-04-11 CRAN (R 3.2.0)                  
##  knitr            1.10       2015-04-23 CRAN (R 3.2.0)                  
##  lattice          0.20-31    2015-03-30 CRAN (R 3.2.0)                  
##  magrittr       * 1.5        2014-11-22 CRAN (R 3.2.0)                  
##  MASS             7.3-40     2015-03-21 CRAN (R 3.2.0)                  
##  memoise          0.2.1      2014-04-22 CRAN (R 3.2.0)                  
##  microbenchmark * 1.4-2      2014-09-28 CRAN (R 3.2.0)                  
##  multcomp         1.4-0      2015-03-05 CRAN (R 3.2.0)                  
##  munsell          0.4.2      2013-07-11 CRAN (R 3.2.0)                  
##  mvtnorm          1.0-2      2014-12-18 CRAN (R 3.2.0)                  
##  plyr             1.8.2      2015-04-21 CRAN (R 3.2.0)                  
##  proto            0.3-10     2012-12-22 CRAN (R 3.2.0)                  
##  qtl            * 1.37-1     2015-04-20 local                           
##  qtl2           * 0.1-18     2015-05-16 local                           
##  Rcpp             0.11.6     2015-05-01 CRAN (R 3.2.0)                  
##  RCurl            1.95-4.6   2015-04-24 CRAN (R 3.2.0)                  
##  reshape2         1.4.1      2014-12-06 CRAN (R 3.2.0)                  
##  RJSONIO          1.3-0      2014-07-28 CRAN (R 3.2.0)                  
##  rmarkdown        0.5.1      2015-01-26 CRAN (R 3.2.0)                  
##  RPushbullet    * 0.2.0      2015-02-09 CRAN (R 3.2.0)                  
##  rversions        1.0.0      2015-04-22 CRAN (R 3.2.0)                  
##  sandwich         2.3-3      2015-03-26 CRAN (R 3.2.0)                  
##  scales           0.2.4      2014-04-22 CRAN (R 3.2.0)                  
##  stringi          0.4-1      2014-12-14 CRAN (R 3.2.0)                  
##  stringr          1.0.0      2015-04-30 CRAN (R 3.2.0)                  
##  survival         2.38-1     2015-02-24 CRAN (R 3.2.0)                  
##  TH.data          1.0-6      2015-01-05 CRAN (R 3.2.0)                  
##  XML              3.98-1.1   2013-06-20 CRAN (R 3.2.0)                  
##  yaml             2.1.13     2014-06-12 CRAN (R 3.2.0)                  
##  zoo              1.7-12     2015-03-16 CRAN (R 3.2.0)</code></pre>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
